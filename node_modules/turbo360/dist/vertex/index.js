"use strict";var Promise=require("bluebird"),superagent=require("superagent"),helper=require("../utils/Helper"),TURBO_VECTOR_API_KEY_HEADER="Turbo-Vector-API-Key",BUCKET="turbo360-vertex",fetchTextFile=function(e){return new Promise(function(r,n){superagent.get(e).query(null).end(function(e,t){if(e)return void n(e);r(t.text)})})},Vertex=function(e){var r=e,n=null,t=function(){return new Promise(function(e,t){if(null!=n)return void e(n);helper.fetchSite(r).then(function(r){n=r,e(n)}).catch(function(e){t(e)})})};return{pageData:function(e){return new Promise(function(n,t){if(null==e)return void t(new Error("Please specify page name"));if(0==e.length)return void t(new Error("Please specify page name"));var i=e.toLowerCase().trim(),o="https://cdn.turbo360-vertex.com/pages/"+r.site_id+"-"+i+".json";superagent.get(o).query(null).set("Accept","application/json").end(function(e,r){if(e)return void t(e);n(r.body)})})},pageConfig:function(e,t){return new Promise(function(i,o){return null==e?void o(new Error("Please specify page name")):0==e.length?void o(new Error("Please specify page name")):void helper.fetchSite(r).then(function(r){if(r.api.key!=t)return void o(new Error("Unauthorized"));n=r;var i="https://s3.amazonaws.com/turbo360-vertex/pages/"+n.slug+"/"+e+".txt";return helper.fetchTextFile(i)}).then(function(e){var r=JSON.parse(e);i(r)}).catch(function(e){o(e)})})},updatePage:function(t,i,o){return new Promise(function(u,a){if(0==helper.validateSiteId(r))return void a(new Error("Please Set Your TURBO_APP_ID"));if(r.site_id.length<20)return void a(new Error("Please Set Your TURBO_APP_ID"));if(null==t)return void a(new Error("Please specify page name"));if(0==t.length)return void a(new Error("Please specify page name"));var s=t+".txt";helper.fetchSite(r).then(function(r){if(r.api.key!=o)return void a(new Error("Unauthorized"));n=r;var c={bucket:BUCKET,filename:s,filetype:"text/plain",folder:"pages/"+n.slug},p=e.turbo_url+"/account/uploadurl";superagent.post(p).send(c).set("Accept","application/json").end(function(e,r){if(e)return void a(e);if("success"!=r.body.confirmation)return void a(new Error(r.body.message));var n={name:s,type:"text/plain"};superagent.put(r.body.data.upload).send(i).set("Content-Type",n.type).end(function(e,r){if(e)return void a(e);u({page:t,status:t+" successfully updated"})})})}).catch(function(e){a(e)})})},currentApp:t}};module.exports=Vertex;